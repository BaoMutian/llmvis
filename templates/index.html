<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>LLM Inference Visualizer</title>
		<link rel="stylesheet" href="/static/css/style.css" />
		<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
	</head>
	<body>
		<div class="app-container">
			<!-- 顶部标题栏 -->
			<header class="app-header">
				<div class="header-title">
					<span class="logo">◈</span>
					<h1>LLM Inference Visualizer</h1>
					<span class="subtitle">探索语言模型的内部机制</span>
				</div>
				<div class="header-status">
					<span id="modelStatus" class="status-badge status-loading"
						>模型加载中...</span
					>
				</div>
			</header>

			<main class="main-content">
				<!-- 左侧面板：输入与参数 -->
				<aside class="left-panel">
					<section class="panel-section model-section">
						<h2 class="section-title">模型</h2>
						<div class="model-path-input">
							<input
								type="text"
								id="modelPath"
								class="text-input"
								placeholder="请输入模型完整路径"
								value=""
							/>
							<button id="loadModelBtn" class="btn btn-secondary">
								<span class="btn-icon">⟳</span>
								加载
							</button>
						</div>
						<div id="modelInfo" class="model-info">
							<span class="info-item"
								><span class="info-label">层数:</span>
								<span id="infoLayers">-</span></span
							>
							<span class="info-item"
								><span class="info-label">注意力头:</span>
								<span id="infoHeads">-</span></span
							>
							<span class="info-item"
								><span class="info-label">隐藏维度:</span>
								<span id="infoHidden">-</span></span
							>
						</div>
					</section>

					<section class="panel-section">
						<h2 class="section-title">输入</h2>
						<textarea
							id="promptInput"
							class="prompt-input"
							placeholder="输入你的问题..."
							rows="4"
						>
解释什么是量子计算。</textarea
						>
						<button id="generateBtn" class="btn btn-primary">
							<span class="btn-icon">▶</span>
							生成
						</button>
					</section>

					<section class="panel-section">
						<h2 class="section-title">推理参数</h2>
						<div class="param-group">
							<label for="temperature">Temperature</label>
							<div class="param-input-row">
								<input
									type="range"
									id="temperature"
									min="0"
									max="2"
									step="0.1"
									value="0.7"
								/>
								<span id="temperatureValue" class="param-value">0.7</span>
							</div>
						</div>
						<div class="param-group">
							<label for="topK">Top-K</label>
							<div class="param-input-row">
								<input
									type="range"
									id="topK"
									min="1"
									max="100"
									step="1"
									value="50"
								/>
								<span id="topKValue" class="param-value">50</span>
							</div>
						</div>
						<div class="param-group">
							<label for="topP">Top-P</label>
							<div class="param-input-row">
								<input
									type="range"
									id="topP"
									min="0"
									max="1"
									step="0.05"
									value="0.9"
								/>
								<span id="topPValue" class="param-value">0.9</span>
							</div>
						</div>
						<div class="param-group">
							<label for="maxTokens">Max Tokens</label>
							<div class="param-input-row">
								<input
									type="range"
									id="maxTokens"
									min="16"
									max="512"
									step="16"
									value="128"
								/>
								<span id="maxTokensValue" class="param-value">128</span>
							</div>
						</div>
					</section>

					<section class="panel-section">
						<h2 class="section-title">可视化选项</h2>
						<div class="param-group">
							<label for="topNProbs">Top-N 概率显示</label>
							<div class="param-input-row">
								<input
									type="range"
									id="topNProbs"
									min="5"
									max="30"
									step="1"
									value="10"
								/>
								<span id="topNProbsValue" class="param-value">10</span>
							</div>
						</div>
						<div class="param-group">
							<label for="attentionLayer">注意力层</label>
							<div class="param-input-row">
								<input
									type="range"
									id="attentionLayer"
									min="0"
									max="35"
									step="1"
									value="0"
								/>
								<span id="attentionLayerValue" class="param-value">0</span>
							</div>
						</div>
						<div class="param-group">
							<label for="attentionHead">注意力头</label>
							<select id="attentionHead" class="select-input">
								<option value="mean">平均 (Mean)</option>
								<option value="max">最大 (Max)</option>
							</select>
						</div>
					</section>

					<section class="panel-section stats-section">
						<h2 class="section-title">统计信息</h2>
						<div class="stats-grid">
							<div class="stat-item">
								<span class="stat-label">生成 Tokens</span>
								<span id="statTokens" class="stat-value">-</span>
							</div>
							<div class="stat-item">
								<span class="stat-label">平均熵</span>
								<span id="statEntropy" class="stat-value">-</span>
							</div>
							<div class="stat-item">
								<span class="stat-label">困惑度</span>
								<span id="statPerplexity" class="stat-value">-</span>
							</div>
							<div class="stat-item">
								<span class="stat-label">平均置信度</span>
								<span id="statConfidence" class="stat-value">-</span>
							</div>
						</div>
					</section>
				</aside>

				<!-- 中间面板：Token展示 -->
				<section class="center-panel">
					<div class="panel-header">
						<h2 class="section-title">生成结果</h2>
						<div class="token-color-mode">
							<span class="hint-text">颜色模式:</span>
							<select id="tokenColorMode" class="select-input-sm">
								<option value="none">无</option>
								<option value="entropy" selected>熵值</option>
								<option value="probability">概率</option>
								<option value="logit">Logit</option>
							</select>
						</div>
					</div>
					<div id="tokenDisplay" class="token-display">
						<div class="placeholder-text">输入提示并点击"生成"按钮开始推理</div>
					</div>
					<div
						id="selectedTokenInfo"
						class="selected-token-info"
						style="display: none"
					>
						<div class="info-header">
							<span class="info-label">选中:</span>
							<span id="selectedToken" class="info-value token-highlight"></span>
							<span class="info-label">位置:</span>
							<span id="selectedPosition" class="info-value"></span>
							<span class="info-label">熵:</span>
							<span id="selectedEntropy" class="info-value"></span>
							<span class="info-label">概率:</span>
							<span id="selectedProb" class="info-value"></span>
							<span class="info-label">Logit:</span>
							<span id="selectedLogit" class="info-value"></span>
						</div>
					</div>
				</section>

				<!-- 拖动分隔条 -->
				<div id="resizeHandle" class="resize-handle"></div>

				<!-- 右侧面板：可视化 -->
				<aside id="rightPanel" class="right-panel">
					<!-- 一级标签：功能分组 -->
					<div class="viz-tabs-primary">
						<button class="tab-btn-primary active" data-group="attention">
							注意力分析
						</button>
						<button class="tab-btn-primary" data-group="hidden">
							隐藏状态
						</button>
						<button class="tab-btn-primary" data-group="token">
							Token分析
						</button>
						<button class="tab-btn-primary" data-group="attribution">
							归因分析
						</button>
					</div>

					<!-- 注意力分析组 -->
					<div id="groupAttention" class="tab-group active">
						<div class="viz-tabs-secondary">
							<button
								class="tab-btn-secondary active"
								data-tab="attention-heatmap"
							>
								热力图
							</button>
							<button class="tab-btn-secondary" data-tab="attention-multihead">
								多头对比
							</button>
							<button class="tab-btn-secondary" data-tab="attention-entropy">
								注意力头熵
							</button>
						</div>
						<div id="tabAttentionHeatmap" class="tab-content active">
							<div id="attentionChart" class="chart-container"></div>
							<div class="chart-info">
								<p>
									热力图显示生成的每个 token（Y轴）对输入和已生成
									token（X轴）的注意力权重
								</p>
							</div>
						</div>
						<div id="tabAttentionMultihead" class="tab-content">
							<div id="multiheadChart" class="chart-container"></div>
							<div class="chart-info">
								<p>对比不同注意力头的注意力模式，发现专门化的注意力头</p>
							</div>
						</div>
						<div id="tabAttentionEntropy" class="tab-content">
							<div id="headEntropyChart" class="chart-container"></div>
							<div class="chart-info">
								<p>每个注意力头的熵值，低熵表示聚焦型，高熵表示分散型</p>
							</div>
						</div>
					</div>

					<!-- 隐藏状态分析组 -->
					<div id="groupHidden" class="tab-group">
						<div class="viz-tabs-secondary">
							<button
								class="tab-btn-secondary active"
								data-tab="hidden-similarity"
							>
								层间相似度
							</button>
							<button class="tab-btn-secondary" data-tab="hidden-residual">
								残差流
							</button>
							<button class="tab-btn-secondary" data-tab="hidden-logits">
								Logits Lens
							</button>
						</div>
						<div id="tabHiddenSimilarity" class="tab-content active">
							<div id="hiddenSimilarityChart" class="chart-container"></div>
							<div class="chart-info">
								<p>层间隐藏状态的余弦相似度，观察信息如何在层间流动</p>
							</div>
						</div>
						<div id="tabHiddenResidual" class="tab-content">
							<div id="residualChart" class="chart-container"></div>
							<div class="chart-info">
								<p>残差连接前后的向量变化，理解每层的贡献</p>
							</div>
						</div>
						<div id="tabHiddenLogits" class="tab-content">
							<div id="logitsLensChart" class="chart-container"></div>
							<div class="chart-info">
								<p>每一层的logits预测，观察模型何时确定答案</p>
							</div>
						</div>
					</div>

					<!-- Token分析组 -->
					<div id="groupToken" class="tab-group">
						<div class="viz-tabs-secondary">
							<button class="tab-btn-secondary active" data-tab="token-probs">
								概率分布
							</button>
							<button class="tab-btn-secondary" data-tab="token-embedding">
								Embedding投影
							</button>
							<button class="tab-btn-secondary" data-tab="token-activation">
								激活分布
							</button>
						</div>
						<div id="tabTokenProbs" class="tab-content active">
							<div id="probsChart" class="chart-container"></div>
							<div class="chart-info">
								<p>显示选中 token 位置的 Top-N 候选概率分布</p>
							</div>
						</div>
						<div id="tabTokenEmbedding" class="tab-content">
							<div class="chart-toolbar">
								<label class="toolbar-label">投影维度:</label>
								<button id="embedding2D" class="toolbar-btn active">2D</button>
								<button id="embedding3D" class="toolbar-btn">3D</button>
							</div>
							<div id="embeddingChart" class="chart-container"></div>
							<div class="chart-info">
								<p>Token embedding的降维投影（PCA），观察语义空间分布</p>
							</div>
						</div>
						<div id="tabTokenActivation" class="tab-content">
							<div id="activationChart" class="chart-container"></div>
							<div class="chart-info">
								<p>MLP和Attention层的激活值分布统计</p>
							</div>
						</div>
					</div>

					<!-- 归因分析组 -->
					<div id="groupAttribution" class="tab-group">
						<div class="viz-tabs-secondary">
							<button class="tab-btn-secondary active" data-tab="attr-entropy">
								熵曲线
							</button>
							<button class="tab-btn-secondary" data-tab="attr-confidence">
								置信度
							</button>
							<button class="tab-btn-secondary" data-tab="attr-input">
								输入归因
							</button>
						</div>
						<div id="tabAttrEntropy" class="tab-content active">
							<div class="chart-toolbar">
								<label class="toolbar-label">排序:</label>
								<select id="entropySortMode" class="select-input-sm">
									<option value="position">按位置</option>
									<option value="desc">高→低</option>
									<option value="asc">低→高</option>
								</select>
								<label class="toolbar-label" style="margin-left: 12px;">高熵阈值:</label>
								<input type="number" id="entropyPercentile" class="number-input-sm" value="75" min="0" max="100" step="5" />
								<span class="toolbar-label">%</span>
							</div>
							<div id="entropyChart" class="chart-container"></div>
							<div class="chart-info">
								<p>熵值越高表示模型在该位置越不确定，分布越均匀</p>
							</div>
						</div>
						<div id="tabAttrConfidence" class="tab-content">
							<div id="confidenceChart" class="chart-container"></div>
							<div class="chart-info">
								<p>置信度曲线显示模型对每个生成 token 的确信程度</p>
							</div>
						</div>
						<div id="tabAttrInput" class="tab-content">
							<div id="attributionChart" class="chart-container"></div>
							<div class="chart-info">
								<p>每个输入token对输出的影响程度（梯度归因）</p>
							</div>
						</div>
					</div>
				</aside>
			</main>
		</div>

		<!-- 加载遮罩 -->
		<div id="loadingOverlay" class="loading-overlay" style="display: none">
			<div class="loading-spinner"></div>
			<p class="loading-text">正在推理中...</p>
		</div>

		<script src="/static/js/api.js"></script>
		<script src="/static/js/charts.js"></script>
		<script src="/static/js/main.js"></script>
	</body>
</html>
