---
name: LLM推理可视化工具
overview: 创建一个基于 Flask + 原生前端 + ECharts 的 LLM 推理可视化工具，使用 transformers 库加载 Qwen3-4B 模型，支持注意力热力图、token概率分布、熵分析等多种可视化功能。
todos:
  - id: init-project
    content: 创建项目目录结构，初始化 git 仓库和 requirements.txt
    status: completed
  - id: model-service
    content: 实现 model_service.py - 模型加载、推理、注意力/logits 提取
    status: completed
    dependencies:
      - init-project
  - id: analysis-module
    content: 实现 analysis.py - 熵计算、概率分布、hidden states 分析
    status: completed
    dependencies:
      - model-service
  - id: flask-api
    content: 实现 app.py - Flask API 端点和路由
    status: completed
    dependencies:
      - analysis-module
  - id: frontend-html-css
    content: 创建 index.html 和 style.css - 页面结构和深色主题样式
    status: completed
    dependencies:
      - init-project
  - id: charts-module
    content: 实现 charts.js - ECharts 热力图、柱状图、折线图封装
    status: completed
    dependencies:
      - frontend-html-css
  - id: main-interaction
    content: 实现 main.js 和 api.js - 用户交互和 API 调用逻辑
    status: completed
    dependencies:
      - charts-module
      - flask-api
  - id: integration-test
    content: 集成测试 - 验证完整功能流程
    status: completed
    dependencies:
      - main-interaction
---

# LLM 推理可视化工具开发计划

## 架构设计

```mermaid
graph TB
    subgraph frontend [前端 - 原生HTML/CSS/JS]
        UI[用户界面]
        ECharts[ECharts可视化]
        TokenDisplay[Token交互展示]
    end
    
    subgraph backend [后端 - Flask API]
        API[REST API]
        ModelService[模型推理服务]
        AnalysisService[分析计算服务]
    end
    
    subgraph model [模型层]
        Transformers[Transformers库]
        Qwen[Qwen3-4B模型]
    end
    
    UI --> API
    API --> ModelService
    ModelService --> Transformers
    Transformers --> Qwen
    ModelService --> AnalysisService
    AnalysisService --> ECharts
```



## 技术选型

| 组件 | 技术 ||------|------|| 后端框架 | Flask || 推理库 | transformers (4.57.3) || 前端 | 原生 HTML/CSS/JavaScript || 可视化 | ECharts || 模型 | ~/evo/models/qwen3-4b-instruct-2507/ |

## 项目结构

```javascript
llmvis/
├── app.py                 # Flask 主应用
├── model_service.py       # 模型加载与推理服务
├── analysis.py            # 熵计算、概率分析等
├── static/
│   ├── css/
│   │   └── style.css      # 样式文件
│   └── js/
│       ├── main.js        # 主逻辑
│       ├── charts.js      # ECharts 图表封装
│       └── api.js         # API 调用封装
├── templates/
│   └── index.html         # 主页面
├── requirements.txt       # Python 依赖
└── README.md              # 项目说明
```



## 核心功能实现

### 1. 模型推理服务 (model_service.py)

- 使用 `transformers` 加载 Qwen3-4B 模型
- 推理时设置 `output_attentions=True` 和 `output_hidden_states=True`
- 返回 logits 用于计算概率分布
- 支持 temperature、top_k、top_p、max_tokens 参数

### 2. 注意力热力图 (第N层)

- 提取指定层的注意力矩阵 `model.outputs.attentions[layer_idx]`
- 支持多头注意力的聚合（平均/最大）或单独查看
- 使用 ECharts heatmap 渲染

### 3. Token 概率分布

- 对每个生成位置的 logits 应用 softmax
- 取 top-N 概率最高的 token
- 点击 token 时展示柱状图

### 4. 熵分析

- 计算公式: `H = -sum(p * log(p))`
- 展示单 token 熵值
- 展示整体熵分布曲线

### 5. 额外探测功能

- Hidden states 余弦相似度（层间变化）
- Token embedding 可视化（降维投影）
- 生成概率置信度曲线

## API 设计

| 端点 | 方法 | 功能 ||------|------|------|| `/api/generate` | POST | 执行推理，返回完整分析数据 || `/api/attention` | GET | 获取指定层注意力矩阵 || `/api/token_probs` | GET | 获取指定位置的 top-N token 概率 |

## 前端界面设计

采用深色主题，简约专业风格：

- 左侧：输入区 + 参数控制面板
- 中间：对话展示区（token 可点击交互）
- 右侧：可视化面板（可切换：注意力热力图/概率分布/熵分析）

## 实现步骤

1. **初始化项目**：创建目录结构，初始化 git 仓库
2. **后端核心**：实现模型加载和推理服务
3. **分析模块**：实现熵计算、概率提取等分析功能
4. **API 层**：实现 Flask REST API
5. **前端基础**：创建 HTML 结构和 CSS 样式